<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Aplikasi Money Tracker Poktan - Atur penjualan dan pengeluaran dengan mudah." />
  <meta name="keywords" content="money tracker, poktan, manajemen keuangan, penjualan, pengeluaran" />
  <meta name="theme-color" content="#6f77ff" />
  <title>Aplikasi Manajemen Poktan</title>

  <!-- font -->
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;800&display=swap" rel="stylesheet"/>

  <style>
    :root {
      --bg: #f6f7fb;
      --card: #fff;
      --muted: #6b7280;
      --accent: #6b7cff;
    }
    body {
      font-family: "Nunito", system-ui, -apple-system, Segoe UI, Roboto,
        "Helvetica Neue", Arial;
      margin: 0;
      background: var(--bg);
      color: #111;
      line-height: 1.5;
    }
    .content {
      padding: 16px;
      max-width: 1200px;
      margin: auto;
    }
    /* hero */
    .hero {
      background: linear-gradient(180deg, #6f77ff 0%, #7f8bff 100%);
      color: #fff;
      padding: 32px 20px;
      border-radius: 14px;
      text-align: center;
      box-shadow: 0 6px 18px rgba(13, 22, 55, 0.08);
      margin-bottom: 20px;
    }
    .hero-welcome {
      font-size: clamp(20px, 5vw, 28px);
      margin: 0 0 10px 0;
      font-weight: 700;
    }
    .hero-sub {
      font-size: clamp(14px, 3.5vw, 16px);
      margin: 0;
      opacity: 0.95;
    }

    /* card */
    .money-card-content {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin: 20px 0;
    }
    .money-card {
      background: var(--card);
      padding: 16px;
      border-radius: 10px;
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.06);
    }
    .card-title {
      margin: 0;
      color: var(--muted);
      font-size: 14px;
    }
    .card-amount {
      margin: 6px 0 0;
      font-weight: 700;
      font-size: 18px;
    }

    /* form */
    .form-section {
      background: var(--card);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.06);
      margin-bottom: 24px;
    }
    .form-title {
      margin: 0 0 16px 0;
      font-size: 18px;
      font-weight: 700;
    }
    .form-input {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #eef2ff;
      background: #fbfdff;
      margin-top: 6px;
      font-size: 14px;
    }
    .product-item {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    .product-item + .product-item {
      margin-top: 10px;
    }

    /* transaction */
    .transaction-section {
      background: var(--card);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.06);
      overflow-x: auto; /* biar tabel bisa geser di hp */
    }
    .transaction-title {
      margin: 0 0 16px 0;
      font-size: 18px;
      font-weight: 700;
    }
    .transaction-table {
      width: 100%;
      border-collapse: collapse;
      min-width: 600px; /* biar tabel rapih dan bisa scroll */
    }
    .transaction-table th,
    .transaction-table td {
      padding: 10px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      font-size: 13px;
    }
    .transaction-table th {
      background: #f9fafb;
      color: var(--muted);
    }
    .type-income { color: green; font-weight: 600; }
    button {
      padding: 12px;
      border-radius: 8px;
      border: none;
      background: var(--accent);
      color: #fff;
      font-weight: bold;
      width: 100%;
      margin-top: 16px;
      cursor: pointer;
    }
    button:hover {
      opacity: 0.9;
    }

    /* responsive tweaks */
    @media (max-width: 480px) {
      .form-section, .transaction-section {
        padding: 16px;
      }
      .product-item { flex-direction: column; align-items: flex-start; }
      .product-item input[type="number"] { width: 100%; margin-top: 8px; }
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
  <div class="content">
    <!-- hero -->
    <section class="hero">
      <h1 class="hero-welcome">Aplikasi Manajemen Poktan</h1>
      <p class="hero-sub">Mari Atur Transaksi Poktan Menjadi Lebih Baik</p>
    </section>

    <!-- card -->
    <div class="money-card-content">
      <div class="money-card total-balance">
        <h3 class="card-title">Total Uang</h3>
        <p class="card-amount">Rp 0</p>
      </div>
      <div class="money-card income">
        <h3 class="card-title">Penjualan</h3>
        <p class="card-amount">Rp 0</p>
      </div>
      <div class="money-card expense">
        <h3 class="card-title">Pengeluaran</h3>
        <p class="card-amount">Rp 0</p>
      </div>
      <div class="money-card expense">
        <h3 class="card-title">Saldo Awal</h3>
        <p class="card-amount">Rp 5.000.000</p>
      </div>
    </div> 

          <!-- Add Transaction (di atas history) -->
      <section class="form-section">
        <h2 class="form-title">Add New Transaction</h2>
        <form class="transaction-form">
          <!-- Nama Pembeli -->
          <label>
            Nama Pembeli
            <input class="form-input" id="buyer-name" placeholder="Masukkan nama pembeli" />
          </label>

          <!-- Pilih Produk -->
          <label style="display:block;margin-top:16px">Pilih Produk</label>
          <div id="product-list" style="margin-top:8px; display:flex; flex-direction:column;">
            <div class="product-item">
              <label style="display:flex; align-items:center; gap:8px; flex:1;">
                <input type="checkbox" class="product-check" value="Urea|150000" />
                <span>Urea (Rp 150.000)</span>
              </label>
              <input type="number" class="qty-input" placeholder="Qty" min="1" style="width:80px;" />
            </div>
            <div class="product-item">
              <label style="display:flex; align-items:center; gap:8px; flex:1;">
                <input type="checkbox" class="product-check" value="Phonska|250000" />
                <span>Phonska (Rp 250.000)</span>
              </label>
              <input type="number" class="qty-input" placeholder="Qty" min="1" style="width:80px;" />
            </div>
            <div class="product-item">
              <label style="display:flex; align-items:center; gap:8px; flex:1;">
                <input type="checkbox" class="product-check" value="Organik|100000" />
                <span>Organik (Rp 100.000)</span>
              </label>
              <input type="number" class="qty-input" placeholder="Qty" min="1" style="width:80px;" />
            </div>
          </div>

          <!-- Total Harga -->
          <label style="display:block;margin-top:16px">
            Total Harga (Rp)
            <input class="form-input" id="total-price" readonly />
          </label>

          <!-- Total Qty -->
          <label style="display:block;margin-top:12px">
            Total Qty
            <input class="form-input" id="total-qty" readonly />
          </label>

          <!-- Tanggal Pembelian -->
          <label style="display:block;margin-top:12px">
            Tanggal Pembelian
            <input type="date" class="form-input" id="purchase-date" />
          </label>

          <!-- Jenis Pembayaran -->
          <label style="display:block;margin-top:12px">
            Jenis Pembayaran
            <select id="transaction-type" class="form-input">
              <option value="Penjualan">Penjualan</option>
              <option value="Pengeluaran">Pengeluaran</option>
            </select>
          </label>

          <!-- Status Pembayaran -->
          <label style="display:block;margin-top:12px">
            Status Pembayaran
            <select id="payment-status" class="form-input">
              <option value="Lunas">Lunas</option>
              <option value="DP">DP</option>
            </select>
          </label>

          <!-- Field Masukan DP -->
          <label id="dp-field" style="display:none;margin-top:12px">
            Masukkan DP (Rp)
            <input type="number" class="form-input" id="dp-amount" placeholder="Masukkan jumlah DP" min="0" />
          </label>

          <button type="button" id="add-btn">Add Transaction</button>
        </form>
      </section>

     <!-- Transaction History -->
    <section class="transaction-section">
      <h2 class="transaction-title">Transaction History</h2>

      <!-- Pilih Bulan & Tahun -->
      <div style="margin-bottom:10px; display:flex; gap:8px; flex-wrap:wrap;">
        <select id="filter-month" class="form-input" style="max-width:150px;">
          <option value="1">Januari</option>
          <option value="2">Februari</option>
          <option value="3">Maret</option>
          <option value="4">April</option>
          <option value="5">Mei</option>
          <option value="6">Juni</option>
          <option value="7">Juli</option>
          <option value="8">Agustus</option>
          <option value="9">September</option>
          <option value="10">Oktober</option>
          <option value="11">November</option>
          <option value="12">Desember</option>
        </select>

        <select id="filter-year" class="form-input" style="max-width:120px;">
          <option value="2025" selected>2025</option>
          <option value="2026">2026</option>
          <option value="2027">2027</option>
        </select>

        <button id="export-pdf">Export PDF</button>
      </div>

      <table class="transaction-table" cellpadding="6">
        <thead>
          <tr>
            <th>Nama Pembeli</th>
            <th>Jumlah Pembelian</th>
            <th>Total Amount</th>
            <th>Tanggal</th>
            <th>Jenis</th>
            <th>Status Pembayaran</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <script>
      const checkboxes = document.querySelectorAll(".product-check");
      const qtyInputs = document.querySelectorAll(".qty-input");
      const totalPrice = document.getElementById("total-price");
      const totalQty = document.getElementById("total-qty");
      const addBtn = document.getElementById("add-btn");

      const buyerName = document.getElementById("buyer-name");
      const purchaseDate = document.getElementById("purchase-date");
      const transactionTable = document.querySelector(".transaction-table tbody");

      const paymentStatus = document.getElementById("payment-status");
      const dpField = document.getElementById("dp-field");
      const dpAmount = document.getElementById("dp-amount");
      const transactionType = document.getElementById("transaction-type");

      const totalUangCard = document.querySelector(".total-balance .card-amount");
      const incomeCard = document.querySelector(".income .card-amount");
      const expenseCard = document.querySelector(".expense .card-amount");
      const saldoAwalCard = document.querySelector(".money-card-content .money-card:nth-child(4) .card-amount");

      let saldoAwal = 5000000;
      let penjualan = 0;
      let pengeluaran = 0;

      // Simpan & Ambil dari localStorage
      function saveToStorage() {
        const data = {
          saldoAwal,
          penjualan,
          pengeluaran,
          rows: transactionTable.innerHTML
        };
        localStorage.setItem("poktanData", JSON.stringify(data));
      }

      function loadFromStorage() {
        const saved = localStorage.getItem("poktanData");
        if (saved) {
          const data = JSON.parse(saved);
          saldoAwal = data.saldoAwal;
          penjualan = data.penjualan;
          pengeluaran = data.pengeluaran;
          transactionTable.innerHTML = data.rows;
          updateCards();

          // aktifkan kembali event "Set Lunas"
          document.querySelectorAll(".mark-paid").forEach(btn => {
            btn.addEventListener("click", () => {
              const row = btn.closest("tr");
              const rowAmount = parseInt(row.dataset.amount);
              const rowDP = parseInt(row.dataset.dp);
              penjualan += (rowAmount - rowDP);
              row.dataset.status = "Lunas";
              row.querySelector(".status-cell").innerHTML = `<span style="color:green">Lunas</span>`;
              btn.remove();
              updateCards();
              saveToStorage();
            });
          });
        }
      }

      // Tampilkan field DP jika dipilih DP
      paymentStatus.addEventListener("change", () => {
        dpField.style.display = paymentStatus.value === "DP" ? "block" : "none";
      });

      // Hitung total harga & qty
      function hitungTotal() {
        let hargaTotal = 0, totalJumlah = 0;
        checkboxes.forEach((checkbox, i) => {
          if (checkbox.checked) {
            const [nama, harga] = checkbox.value.split("|");
            const qty = parseInt(qtyInputs[i].value || 0);
            if (qty > 0) {
              hargaTotal += parseInt(harga) * qty;
              totalJumlah += qty;
            }
          }
        });
        totalPrice.value = hargaTotal;
        totalQty.value = totalJumlah;
      }

      checkboxes.forEach(cb => cb.addEventListener("change", hitungTotal));
      qtyInputs.forEach(q => q.addEventListener("input", hitungTotal));

      // Update card summary
      function updateCards() {
        totalUangCard.textContent = "Rp " + (saldoAwal + penjualan - pengeluaran).toLocaleString();
        incomeCard.textContent = "Rp " + penjualan.toLocaleString();
        expenseCard.textContent = "Rp " + pengeluaran.toLocaleString();
        saldoAwalCard.textContent = "Rp " + saldoAwal.toLocaleString();
      }

      // Tambah transaksi
      addBtn.addEventListener("click", () => {
        const buyer = buyerName.value;
        const date = purchaseDate.value;
        const amount = parseInt(totalPrice.value || 0);
        const qtyTotal = totalQty.value;
        const jenis = transactionType.value;
        const status = paymentStatus.value;
        const dp = parseInt(dpAmount.value || 0);

        let produkDipilih = [];
        checkboxes.forEach((checkbox, i) => {
          if (checkbox.checked && qtyInputs[i].value > 0) {
            produkDipilih.push(`${checkbox.value.split("|")[0]} x${qtyInputs[i].value}`);
          }
        });

        if (!buyer || !date || produkDipilih.length === 0) {
          alert("Lengkapi semua data transaksi!");
          return;
        }

        let statusHTML = `<span style="color:${status === "Lunas" ? "green" : "orange"}">
          ${status}${status === "DP" ? " (Rp " + dp.toLocaleString() + ")" : ""}
        </span>`;

        let actionHTML = status === "DP" ? `<button class="mark-paid">Set Lunas</button>` : "";

        let newRow = `
          <tr data-amount="${amount}" data-dp="${dp}" data-status="${status}" data-jenis="${jenis}">
            <td>${buyer}</td>
            <td>${produkDipilih.join(", ")}</td>
            <td>Rp ${amount.toLocaleString()}</td>
            <td>${date}</td>
            <td>${jenis}</td>
            <td class="status-cell">${statusHTML}</td>
            <td>${actionHTML}</td>
          </tr>
        `;

        transactionTable.insertAdjacentHTML("beforeend", newRow);

        if (jenis === "Penjualan") {
          if (status === "DP") {
            penjualan += dp;
          } else {
            penjualan += amount;
          }
        } else if (jenis === "Pengeluaran") {
          pengeluaran += amount;
        }
        updateCards();

        // event tombol set lunas
        const lastRow = transactionTable.lastElementChild;
        lastRow.querySelector(".mark-paid")?.addEventListener("click", () => {
          const rowAmount = parseInt(lastRow.dataset.amount);
          const rowDP = parseInt(lastRow.dataset.dp);
          penjualan += (rowAmount - rowDP);
          lastRow.dataset.status = "Lunas";
          lastRow.querySelector(".status-cell").innerHTML = `<span style="color:green">Lunas</span>`;
          lastRow.querySelector(".mark-paid").remove();
          updateCards();
          saveToStorage();
        });

        // reset form
        buyerName.value = "";
        purchaseDate.value = "";
        totalPrice.value = "";
        totalQty.value = "";
        dpAmount.value = "";
        paymentStatus.value = "Lunas";
        dpField.style.display = "none";
        checkboxes.forEach((cb, i) => {
          cb.checked = false;
          qtyInputs[i].value = "";
        });

        saveToStorage();
      });

      // Inisialisasi awal
      updateCards();
      loadFromStorage();
      const exportBtn = document.getElementById("export-pdf");

      exportBtn.addEventListener("click", () => {
        const bulan = document.getElementById("filter-month").value;
        const tahun = document.getElementById("filter-year").value;

        // filter transaksi sesuai bulan & tahun
        const rows = document.querySelectorAll(".transaction-table tbody tr");
        let dataExport = [];
        rows.forEach(row => {
          const tgl = row.cells[3].textContent;
          if (tgl) {
            const [y, m] = tgl.split("-"); // format input date yyyy-mm-dd
            if (parseInt(m) === parseInt(bulan) && parseInt(y) === parseInt(tahun)) {
              dataExport.push([
                row.cells[0].textContent, // Nama Pembeli
                row.cells[1].textContent, // Jumlah Pembelian
                row.cells[2].textContent, // Total Amount
                row.cells[3].textContent, // Tanggal
                row.cells[4].textContent, // Jenis
                row.cells[5].textContent, // Status
              ]);
            }
          }
        });

        if (dataExport.length === 0) {
          alert("Tidak ada transaksi pada periode ini.");
          return;
        }

        // ambil nilai card summary
        const totalUang = document.querySelector(".total-balance .card-amount").textContent;
        const penjualanVal = document.querySelector(".income .card-amount").textContent;
        const pengeluaranVal = document.querySelector(".expense .card-amount").textContent;
        const saldoAwalVal = document.querySelector(".money-card-content .money-card:nth-child(4) .card-amount").textContent;

        // buat PDF
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Judul
        doc.setFontSize(14);
        doc.text("Laporan Transaksi Poktan", 14, 15);
        doc.setFontSize(11);
        doc.text(`Periode: ${document.getElementById("filter-month").selectedOptions[0].text} ${tahun}`, 14, 22);

        // Card summary di PDF
        doc.setFontSize(11);
        doc.text(`Total Uang   : ${totalUang}`, 14, 35);
        doc.text(`Penjualan    : ${penjualanVal}`, 14, 42);
        doc.text(`Pengeluaran  : ${pengeluaranVal}`, 14, 49);
        doc.text(`Saldo Awal   : ${saldoAwalVal}`, 14, 56);

        // tabel transaksi
        doc.autoTable({
          startY: 65,
          head: [["Nama Pembeli", "Jumlah Pembelian", "Total Amount", "Tanggal", "Jenis", "Status"]],
          body: dataExport,
          styles: { fontSize: 9 }
        });

        doc.save(`Transaksi_${bulan}_${tahun}.pdf`);
      });
    </script>
  </body>
</html>